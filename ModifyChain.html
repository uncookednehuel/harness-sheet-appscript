<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <style>
      :root{
        --label-col-w: 90px;
        --cell-h: 22px;
        --border: #cbd5e1;
        --text: #111827;
        --muted: #6b7280;
      }

      body {
        font-family: Arial, sans-serif;
        margin: 10px;
        color: var(--text);
        font-size: 12px;
        text-align: center;
      }

      h2 {
        margin: 0 0 6px 0;
        font-size: 15px;
        text-align: center;
      }

      .instructions-text {
        margin-bottom: 8px;
        line-height: 1.3;
        text-align: center;
      }

      .section-title {
        font-size: 11px;
        color: var(--muted);
        margin: 6px 0 2px 0;
        text-align: center;
      }

      table.matrix {
        border-collapse: collapse;
        margin: 0 auto 6px auto;
        table-layout: fixed;
      }

      table.matrix td,
      table.matrix th {
        border: 1px solid var(--border);
        height: var(--cell-h);
        padding: 5px 10px;
        text-align: center;
        font-size: 11px;
        background: none;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        vertical-align: middle;
      }

      table.matrix th.row-label {
        width: var(--label-col-w);
        font-weight: 600;
        text-align: center;
      }

      table.input-matrix td,
      table.input-matrix th {
        padding: 0;
      }

      .cell-input {
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        border: 0;
        outline: none;
        padding: 0 3px;
        font-size: 11px;
        background: transparent;
        text-align: center;
      }

      .cell-input:focus {
        outline: 1px solid #2563eb;
        outline-offset: -1px;
      }

      .footer-bar {
        display: flex;
        justify-content: center;
        gap: 6px;
        margin-top: 6px;
      }

      .btn {
        font-size: 11px;
        padding: 4px 8px;
        border: 1px solid var(--border);
        background: white;
        cursor: pointer;
      }

      .btn-primary {
        border-color: #2563eb;
        background: #2563eb;
        color: white;
      }
    </style>
  </head>

  <body>
    <h2>Matrix Editor</h2>

    <div class="instructions-text">Text here</div>

    <div class="section-title">Current values</div>
    <table id="displayTable" class="matrix"></table>

    <div class="section-title">Edit values</div>
    <table id="inputTable" class="matrix input-matrix"></table>

    <div class="footer-bar">
      <button class="btn" onclick="onRevert()">Revert</button>
      <button class="btn btn-primary" onclick="onUpdateChain()">Update chain</button>
    </div>

    <script>
      let connectorList = [];
      let pinList = [];

      document.addEventListener("DOMContentLoaded", init);

      function init() {
        readListsFromAppsScript();
      }

      function readListsFromAppsScript() {
        google.script.run
          .withSuccessHandler(onConnectorListLoaded)
          .withFailureHandler(onLoadError)
          .GetConnectorList();
      }

      function onConnectorListLoaded(list) {
        connectorList = Array.isArray(list) ? list : [];
        google.script.run
          .withSuccessHandler(onPinListLoaded)
          .withFailureHandler(onLoadError)
          .GetPinList();
      }

      function onPinListLoaded(list) {
        pinList = Array.isArray(list) ? list : [];
        renderTablesFromLists(connectorList, pinList);
      }

      function onLoadError(err) {
        console.error(err);
      }

      function renderTablesFromLists(connectors, pins) {
        const n = Math.max(connectors.length, pins.length);

        const displayData = {
          connector: connectors.slice(0, n),
          pin: pins.slice(0, n)
        };

        buildDisplayTable("displayTable", displayData, n);
        buildInputTable("inputTable", displayData, n);

        applySharedColumnWidths("displayTable", "inputTable");
      }

      function buildDisplayTable(id, data, n) {
        const t = document.getElementById(id);
        t.innerHTML = "";

        ["connector", "pin"].forEach(row => {
          const tr = document.createElement("tr");

          const th = document.createElement("th");
          th.className = "row-label";
          th.textContent = row;
          tr.appendChild(th);

          for (let i = 0; i < n; i++) {
            const td = document.createElement("td");
            td.textContent = data[row][i] ?? "";
            tr.appendChild(td);
          }

          t.appendChild(tr);
        });
      }

      function buildInputTable(id, data, n) {
        const t = document.getElementById(id);
        t.innerHTML = "";

        ["connector", "pin"].forEach(row => {
          const tr = document.createElement("tr");

          const th = document.createElement("th");
          th.className = "row-label";
          th.textContent = row;
          tr.appendChild(th);

          for (let i = 0; i < n; i++) {
            const td = document.createElement("td");
            const input = document.createElement("input");
            input.className = "cell-input";
            input.type = "text";
            input.placeholder = data[row][i] ?? "";
            input.dataset.row = row;
            input.dataset.col = i;
            td.appendChild(input);
            tr.appendChild(td);
          }

          t.appendChild(tr);
        });
      }

      function applySharedColumnWidths(displayId, inputId) {
        const display = document.getElementById(displayId);
        const input = document.getElementById(inputId);

        if (!display.rows.length) return;

        const widths = Array.from(display.rows[0].cells).map(cell =>
          Math.round(cell.getBoundingClientRect().width)
        );

        setColgroup(display, widths);
        setColgroup(input, widths);

        const w = Math.round(display.getBoundingClientRect().width);
        input.style.width = w + "px";
      }

      function setColgroup(tableEl, widths) {
        const existing = tableEl.querySelector("colgroup");
        if (existing) existing.remove();

        const colgroup = document.createElement("colgroup");
        widths.forEach(w => {
          const col = document.createElement("col");
          col.style.width = w + "px";
          colgroup.appendChild(col);
        });

        tableEl.insertBefore(colgroup, tableEl.firstChild);
      }

      window.addEventListener("resize", () => applySharedColumnWidths("displayTable", "inputTable"));

      function onRevert() {
        renderTablesFromLists(connectorList, pinList);
      }

      function onUpdateChain() {
        console.log("Update chain");
      }
    </script>
  </body>
</html>